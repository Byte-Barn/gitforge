# .github/workflows/publish-npm.yml
name: Publish NPM packages

on:
  workflow_call:
    secrets:
      NPM_TOKEN:
        required: true
  workflow_dispatch:

jobs:
  publish:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set version
        run: |
          VERSION="${GITHUB_REF#refs/tags/v}"
          if [[ "$VERSION" == "$GITHUB_REF" ]]; then
            VERSION="0.0.0-dev"
          fi
          echo "VERSION=$VERSION" >> $GITHUB_ENV

      - name: Download all binary artifacts
        uses: actions/download-artifact@v4
        with:
          pattern: binary-*
          path: binaries
          merge-multiple: false  # keeps each artifact in its own dir

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          registry-url: 'https://registry.npmjs.org'

      - name: Publish platform-specific and unified packages
        run: |
          # Map artifact names to npm metadata
          declare -A PKG_MAP
          PKG_MAP["binary-linux-x64-glibc"]="gitcraft-linux-x64 linux x64"
          PKG_MAP["binary-linux-arm64-glibc"]="gitcraft-linux-arm64 linux arm64"
          PKG_MAP["binary-darwin-x64"]="gitcraft-darwin-x64 darwin x64"
          PKG_MAP["binary-darwin-arm64"]="gitcraft-darwin-arm64 darwin arm64"
          PKG_MAP["binary-windows-x64-msvc"]="gitcraft-windows-x64 win32 x64"

          mkdir -p npm-pkgs

          # Process each artifact
          for artifact_dir in binaries/binary-*; do
            artifact=$(basename "$artifact_dir")
            if [[ ! -d "$artifact_dir" ]]; then continue; fi

            if [[ -z "${PKG_MAP[$artifact]}" ]]; then
              echo "⚠️ Skipping unsupported artifact: $artifact"
              continue
            fi

            read -r PKG_NAME OS CPU <<< "${PKG_MAP[$artifact]}"
            BINARY_FILE=$(ls "$artifact_dir")
            if [[ -z "$BINARY_FILE" ]]; then
              echo "❌ No binary in $artifact"
              continue
            fi

            # Determine final binary name inside package
            FINAL_BIN="gitcraft"
            if [[ "$OS" == "win32" ]]; then
              FINAL_BIN="gitcraft.exe"
            fi

            # Create package
            PKG_PATH="npm-pkgs/$PKG_NAME"
            mkdir -p "$PKG_PATH/bin"
            cp "$artifact_dir/$BINARY_FILE" "$PKG_PATH/bin/$FINAL_BIN"
            [[ "$OS" != "win32" ]] && chmod +x "$PKG_PATH/bin/$FINAL_BIN"

            cat > "$PKG_PATH/package.json" << EOF
          {
            "name": "$PKG_NAME",
            "version": "${VERSION}",
            "os": ["$OS"],
            "cpu": ["$CPU"],
            "bin": { "gitcraft": "./bin/$FINAL_BIN" },
            "files": ["bin/"],
            "license": "Apache-2.0",
            "description": "Prebuilt gitcraft binary for $OS/$CPU"
          }
          EOF

            # Publish
            cd "$PKG_PATH"
            npm publish --access public
            cd ../..
          done

          # Build unified package
          mkdir -p gitcraft-unified/bin
          cat > gitcraft-unified/bin/gitcraft.js << 'EOF'
          #!/usr/bin/env node
          const os = require('os');
          const child_process = require('child_process');
          const path = require('path');

          const platform = os.platform();
          const arch = os.arch();

          let pkg;
          if (platform === 'linux' && arch === 'arm64') pkg = 'gitcraft-linux-arm64';
          else if (platform === 'linux' && arch === 'x64') pkg = 'gitcraft-linux-x64';
          else if (platform === 'darwin' && arch === 'arm64') pkg = 'gitcraft-darwin-arm64';
          else if (platform === 'darwin' && arch === 'x64') pkg = 'gitcraft-darwin-x64';
          else if (platform === 'win32' && arch === 'x64') pkg = 'gitcraft-windows-x64';
          else {
            console.error(`Unsupported platform: ${platform} ${arch}`);
            process.exit(1);
          }

          try {
            const pkgPath = require.resolve(`${pkg}/package.json`);
            const binName = platform === 'win32' ? 'gitcraft.exe' : 'gitcraft';
            const binPath = path.join(path.dirname(pkgPath), 'bin', binName);
            child_process.execFileSync(binPath, process.argv.slice(2), { stdio: 'inherit' });
          } catch (e) {
            if (e.code === 'MODULE_NOT_FOUND') {
              console.error(`Missing platform package: ${pkg}`);
              console.error(`Run: npm install -g ${pkg}`);
              process.exit(1);
            } else {
              process.exit(e.status || 1);
            }
          }
          EOF

                    chmod +x gitcraft-unified/bin/gitcraft.js

                    cat > gitcraft-unified/package.json << EOF
          {
            "name": "gitcraft",
            "version": "${VERSION}",
            "description": "A CLI tool for GitHub-related utilities",
            "bin": { "gitcraft": "./bin/gitcraft.js" },
            "files": ["bin/"],
            "license": "Apache-2.0",
            "optionalDependencies": {
              "gitcraft-linux-x64": "${VERSION}",
              "gitcraft-linux-arm64": "${VERSION}",
              "gitcraft-darwin-x64": "${VERSION}",
              "gitcraft-darwin-arm64": "${VERSION}",
              "gitcraft-windows-x64": "${VERSION}"
            },
            "engines": { "node": ">=14" }
          }
          EOF

                    cd gitcraft-unified
                    npm publish --access public
        env:
          VERSION: ${{ env.VERSION }}
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}